<!DOCTYPE html>
<html>
<head>
  <title>D&D —Å AI-–º–∞—Å—Ç–µ—Ä–æ–º | –ò–≥—Ä–æ–≤–æ–π —á–∞—Ç</title>
  <meta charset="UTF-8">
  <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --primary: #4a6fa5;
      --secondary: #166088;
      --dark: #0a2463;
      --light: #f8f9fa;
      --danger: #d64045;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f5f5f5;
      margin: 0;
      padding: 20px;
      color: #333;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      border-radius: 10px;
      box-shadow: 0 0 15px rgba(0,0,0,0.1);
      padding: 20px;
    }
    h1 {
      color: var(--dark);
      text-align: center;
      margin-bottom: 20px;
    }
    #chat {
      height: 60vh;
      overflow-y: auto;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      background: white;
    }
    .msg {
      margin: 10px 0;
      padding: 10px 15px;
      border-radius: 12px;
      max-width: 80%;
      word-wrap: break-word;
    }
    .dm {
      background: #e6f7ff;
      color: var(--secondary);
      border: 1px solid #b3e0ff;
      float: left;
      clear: both;
    }
    .player {
      background: #f0f0f0;
      color: #000;
      border: 1px solid #ddd;
      float: right;
      clear: both;
    }
    .system {
      color: #666;
      font-style: italic;
      text-align: center;
      margin: 15px auto;
      clear: both;
    }
    .dice-roll {
      color: #d64045;
      font-weight: bold;
    }
    .input-area {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }
    #message {
      flex-grow: 1;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 16px;
    }
    button {
      padding: 12px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.2s;
    }
    .btn-primary {
      background: var(--primary);
      color: white;
    }
    .btn-primary:hover {
      background: var(--secondary);
    }
    .btn-danger {
      background: var(--danger);
      color: white;
    }
    .dice-btn {
      background: #ff9a76;
      color: white;
    }
    #character-info {
      background: #f8f9fa;
      padding: 10px;
      border-radius: 6px;
      margin-bottom: 15px;
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>‚öîÔ∏è <span id="session-name">–ò–≥—Ä–æ–≤–∞—è —Å–µ—Å—Å–∏—è</span></h1>
    
    <div id="character-info">
      <h3>–í–∞—à –ø–µ—Ä—Å–æ–Ω–∞–∂: <span id="char-name"></span></h3>
      <p><span id="char-race-class"></span> | <span id="char-background"></span></p>
    </div>

    <div id="login">
      <div class="input-area">
        <input type="text" id="room" placeholder="ID –∫–æ–º–Ω–∞—Ç—ã" value="">
        <input type="text" id="name" placeholder="–í–∞—à–µ –∏–º—è" value="">
        <button class="btn-primary" onclick="join()">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</button>
      </div>
    </div>

    <div id="game" style="display: none;">
      <div id="chat"></div>
      <div class="input-area">
        <input type="text" id="message" placeholder="–í–∞—à–µ –¥–µ–π—Å—Ç–≤–∏–µ –∏–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ..." onkeypress="if(event.key==='Enter') send()">
        <button class="btn-primary" onclick="send()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        <button class="dice-btn" onclick="roll('1d20')">d20</button>
        <button class="dice-btn" onclick="roll('1d6')">d6</button>
        <button class="btn-danger" onclick="leaveRoom()">–í—ã–π—Ç–∏</button>
      </div>
    </div>
  </div>

  <!-- Socket.IO –∏ Supabase -->
  <script src="/socket.io/socket.io.js"></script>
  <script>
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Supabase
    const supabaseUrl = 'https://xjimqtbzbxqmkgavizxy.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhqaW1xdGJ6YnhxbWtnYXZpenh5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ1ODMzNDQsImV4cCI6MjA3MDE1OTM0NH0.QeZIjiYR1HcUzvAqUOnjXbFCMyxY9P6SbzQKWQm-ueI';
    const sb = window.supabase.createClient(supabaseUrl, supabaseKey);

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Socket.IO
    const socket = io("http://localhost:10000", {
      reconnection: true,
      transports: ["websocket"]
    });
    
    let currentRoomId = null;
    let playerName = '';
    let currentCharacter = null;

    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
    document.addEventListener('DOMContentLoaded', async () => {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
      const { data: { session } } = await sb.auth.getSession();
      if (!session?.user) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É');
        window.location.href = '/gamemenu';
        return;
      }

      // –ü—ã—Ç–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
      const savedCharacter = localStorage.getItem('currentCharacter');
      if (savedCharacter) {
        currentCharacter = JSON.parse(savedCharacter);
        showCharacterInfo(currentCharacter);
      }

      // –ï—Å–ª–∏ –µ—Å—Ç—å ID —Å–µ—Å—Å–∏–∏ –≤ URL
      const urlParams = new URLSearchParams(window.location.search);
      const sessionId = urlParams.get('session');
      if (sessionId) {
        document.getElementById('room').value = sessionId;
      }
    });

    function showCharacterInfo(character) {
      document.getElementById('character-info').style.display = 'block';
      document.getElementById('char-name').textContent = character.name;
      document.getElementById('char-race-class').textContent = `${character.race} (${character.class})`;
      document.getElementById('char-background').textContent = character.background.substring(0, 50) + '...';
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π —á–∞—Ç–∞
    socket.on('chat message', (msg) => {
      if (msg.roomId === currentRoomId) {
        addMessage(msg.sender, msg.content);
      }
    });

    socket.on('chat history', (history) => {
      history.forEach(msg => addMessage(msg.sender, msg.content));
    });

    socket.on('connect_error', (err) => {
      console.error('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:', err);
      alert('–°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
    });

    // –§—É–Ω–∫—Ü–∏–∏ —á–∞—Ç–∞
    function join() {
      currentRoomId = document.getElementById('room').value.trim();
      playerName = document.getElementById('name').value.trim();
      
      if (!currentRoomId || !playerName) {
        alert("–£–∫–∞–∂–∏—Ç–µ ID –∫–æ–º–Ω–∞—Ç—ã –∏ –≤–∞—à–µ –∏–º—è!");
        return;
      }

      document.getElementById('login').style.display = 'none';
      document.getElementById('game').style.display = 'block';
      
      // –ï—Å–ª–∏ –µ—Å—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂ - –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ –∏–º—è
      if (currentCharacter) {
        playerName = currentCharacter.name;
      }

      socket.emit('join', { 
        roomId: currentRoomId, 
        name: playerName 
      });
      
      addMessage('–°–∏—Å—Ç–µ–º–∞', `–í—ã –≤–æ—à–ª–∏ –≤ –∫–æ–º–Ω–∞—Ç—É "${currentRoomId}"`);
      document.title = `D&D: ${currentRoomId} | ${playerName}`;
    }

    function send() {
      const input = document.getElementById('message');
      const msg = input.value.trim();
      if (msg) {
        socket.emit('chat message', { 
          roomId: currentRoomId, 
          content: msg, 
          sender: playerName 
        });
        input.value = '';
      }
    }

    function roll(dice) {
      const rollMsg = `/roll ${dice}`;
      socket.emit('chat message', { 
        roomId: currentRoomId, 
        content: rollMsg, 
        sender: playerName 
      });
    }

    function leaveRoom() {
      socket.emit('leave', { roomId: currentRoomId });
      window.location.href = '/sessions-list';
    }

    function addMessage(sender, content) {
      const chat = document.getElementById('chat');
      const div = document.createElement('div');
      
      // –û–±—Ä–∞–±–æ—Ç–∫–∞ –±—Ä–æ—Å–∫–æ–≤ –∫—É–±–∏–∫–æ–≤
      if (content.includes('/roll')) {
        content = content.replace('/roll', '<span class="dice-roll">üé≤ –ë—Ä–æ—Å–æ–∫:</span>');
      }

      div.className = 'msg ' + (
        sender === 'DM' ? 'dm' : 
        sender === '–°–∏—Å—Ç–µ–º–∞' ? 'system' : 
        'player'
      );
      
      div.innerHTML = `<strong>${sender}:</strong> ${content}`;
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }
  </script>
</body>
</html>