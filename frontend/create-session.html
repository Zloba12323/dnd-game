<!DOCTYPE html>
<html>
<head>
  <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    const supabaseUrl = 'https://xjimqtbzbxqmkgavizxy.supabase.co'
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhqaW1xdGJ6YnhxbWtnYXZpenh5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ1ODMzNDQsImV4cCI6MjA3MDE1OTM0NH0.QeZIjiYR1HcUzvAqUOnjXbFCMyxY9P6SbzQKWQm-ueI'
    const sb = window.supabase.createClient(supabaseUrl, supabaseKey)
  </script>

  <style>
    .form-container {
      max-width: 500px;
      margin: 30px auto;
      padding: 20px;
      background: #f9f9f9;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    h2 {
      color: #333;
      text-align: center;
      margin-bottom: 20px;
    }
    input, select, textarea, button {
      display: block;
      width: 100%;
      margin: 10px 0;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 16px;
    }
    textarea {
      height: 150px;
      resize: vertical;
    }
    button {
      background-color: #4CAF50;
      color: white;
      border: none;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    button:hover {
      background-color: #45a049;
    }
    .loading {
      opacity: 0.7;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <div class="form-container">
    <h2>–ù–æ–≤–æ–µ –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏–µ</h2>
    <input type="text" id="session-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä: '–ü–æ—Ö–æ–¥ –∑–∞ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–º')" required>
    
    <select id="genre" required>
      <option value="" disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ –∂–∞–Ω—Ä</option>
      <option value="fantasy">–§—ç–Ω—Ç–µ–∑–∏</option>
      <option value="horror">–£–∂–∞—Å—ã</option>
      <option value="steampunk">–°—Ç–∏–º–ø–∞–Ω–∫</option>
      <option value="postapocalyptic">–ü–æ—Å—Ç–∞–ø–æ–∫–∞–ª–∏–ø—Å–∏—Å</option>
    </select>
    
    <button id="generate-btn" onclick="generateStory()">‚ú® –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–µ–¥—ã—Å—Ç–æ—Ä–∏—é</button>
    <textarea id="story" placeholder="–û–ø–∏—à–∏—Ç–µ –ø—Ä–µ–¥—ã—Å—Ç–æ—Ä–∏—é –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏..." required></textarea>
    
    <button id="save-btn" onclick="saveSession()">üéÆ –°–æ–∑–¥–∞—Ç—å —Å–µ—Å—Å–∏—é</button>
  </div>

  <script>
    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–µ–¥—ã—Å—Ç–æ—Ä–∏–∏ —Å –ø–æ–º–æ—â—å—é AI
    async function generateStory() {
      const sessionName = document.getElementById('session-name').value;
      const genre = document.getElementById('genre').value;
      
      if (!sessionName || !genre) {
        alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ –≤—ã–±–µ—Ä–∏—Ç–µ –∂–∞–Ω—Ä!');
        return;
      }

      const btn = document.getElementById('generate-btn');
      btn.disabled = true;
      btn.classList.add('loading');
      btn.textContent = '–ì–µ–Ω–µ—Ä–∞—Ü–∏—è...';

      try {
        // –ó–¥–µ—Å—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤–∞—à –∑–∞–ø—Ä–æ—Å –∫ API –Ω–µ–π—Ä–æ—Å–µ—Ç–∏
        // –ü—Ä–∏–º–µ—Ä –¥–ª—è DeepSeek:
        const prompt = `–°–æ–∑–¥–∞–π –ø—Ä–µ–¥—ã—Å—Ç–æ—Ä–∏—é –¥–ª—è D&D —Å–µ—Å—Å–∏–∏:
–ù–∞–∑–≤–∞–Ω–∏–µ: ${sessionName}
–ñ–∞–Ω—Ä: ${genre}
–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:
1. 3-5 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π
2. –í–∫–ª—é—á–∏ –∑–∞–≤—è–∑–∫—É —Å—é–∂–µ—Ç–∞
3. –£–∫–∞–∂–∏ –≤–æ–∑–º–æ–∂–Ω—ã–µ –ª–æ–∫–∞—Ü–∏–∏`;

        // –ò–º–∏—Ç–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–∞ (–∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π –≤—ã–∑–æ–≤ API)
        await new Promise(resolve => setTimeout(resolve, 1500));
        const generatedStory = `–í –∫–æ—Ä–æ–ª–µ–≤—Å—Ç–≤–µ ${sessionName} –Ω–∞–∑—Ä–µ–≤–∞–µ—Ç –∫—Ä–∏–∑–∏—Å. ${{
          fantasy: "–î—Ä–µ–≤–Ω–∏–π –∞—Ä—Ç–µ—Ñ–∞–∫—Ç –ø—Ä–æ–±—É–¥–∏–ª—Å—è –≤ —Ä—É–∏–Ω–∞—Ö —ç–ª—å—Ñ–∏–π—Å–∫–æ–≥–æ –≥–æ—Ä–æ–¥–∞.",
          horror: "–ò–∑ –∑–∞–±—Ä–æ—à–µ–Ω–Ω–æ–≥–æ —Ö—Ä–∞–º–∞ –¥–æ–Ω–æ—Å—è—Ç—Å—è —Å—Ç—Ä–∞–Ω–Ω—ã–µ –∑–≤—É–∫–∏ –ø–æ –Ω–æ—á–∞–º.",
          steampunk: "–ú–µ—Ö–∞–Ω–∏—á–µ—Å–∫–∏–π –¥—Ä–∞–∫–æ–Ω —Ç–µ—Ä—Ä–æ—Ä–∏–∑–∏—Ä—É–µ—Ç –Ω–∏–∂–Ω–∏–µ —É—Ä–æ–≤–Ω–∏ –≥–æ—Ä–æ–¥–∞.",
          postapocalyptic: "–ü–æ—Å–ª–µ–¥–Ω–∏–µ –≤—ã–∂–∏–≤—à–∏–µ –æ–±–Ω–∞—Ä—É–∂–∏–ª–∏ –±—É–Ω–∫–µ—Ä —Å –ø—Ä–∏–ø–∞—Å–∞–º–∏."
        }[genre]} –ì–µ—Ä–æ—è–º –ø—Ä–µ–¥—Å—Ç–æ–∏—Ç –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç—å ${{
          fantasy: "–∑–∞–±—ã—Ç—ã–µ –ø–æ–¥–∑–µ–º–µ–ª—å—è –∏ –¥—Ä–µ–≤–Ω–∏–µ –ª–µ—Å–∞",
          horror: "–ø—Ä–æ–∫–ª—è—Ç—ã–µ –∫–∞—Ç–∞–∫–æ–º–±—ã –∏ –∑–∞–±—Ä–æ—à–µ–Ω–Ω—ã–µ –¥–µ—Ä–µ–≤–Ω–∏",
          steampunk: "–∑–∞–≤–æ–¥—ã –∏ –≤–æ–∑–¥—É—à–Ω—ã–µ –¥–æ–∫–∏",
          postapocalyptic: "—Ä—É–∏–Ω—ã –≥–æ—Ä–æ–¥–æ–≤ –∏ —Ä–∞–¥–∏–æ–∞–∫—Ç–∏–≤–Ω—ã–µ –ø—É—Å—Ç–æ—à–∏"
        }[genre]}.`;

        document.getElementById('story').value = generatedStory;
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏:', error);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø—Ä–µ–¥—ã—Å—Ç–æ—Ä–∏–∏');
      } finally {
        btn.disabled = false;
        btn.classList.remove('loading');
        btn.textContent = '‚ú® –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–µ–¥—ã—Å—Ç–æ—Ä–∏—é';
      }
    }

    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏ –≤ Supabase
    async function saveSession() {
      const sessionName = document.getElementById('session-name').value;
      const genre = document.getElementById('genre').value;
      const story = document.getElementById('story').value;
      
      if (!sessionName || !genre || !story) {
        alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!');
        return;
      }

      const btn = document.getElementById('save-btn');
      btn.disabled = true;
      btn.classList.add('loading');
      btn.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';

      try {
        const { data: { session } } = await sb.auth.getSession();
        const user = session?.user;
        if (!user) {
          alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É');
          window.location.href = '/gamemenu';
          return;
        }

        const { data, error } = await sb
          .from('sessions')
          .insert([{
            name: sessionName,
            genre: genre,
            story: story,
            status: 'active',
            created_by: user.id
          }])
          .select();

        if (error) throw error;

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º ID —Å–µ—Å—Å–∏–∏ –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
        localStorage.setItem('currentSessionId', data[0].id);
        alert('–°–µ—Å—Å–∏—è —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞!');
        window.location.href = "/create-character";
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–µ—Å—Å–∏–∏: ' + error.message);
      } finally {
        btn.disabled = false;
        btn.classList.remove('loading');
        btn.textContent = 'üéÆ –°–æ–∑–¥–∞—Ç—å —Å–µ—Å—Å–∏—é';
      }
    }

    // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º—ã –ø—Ä–∏ –≤–≤–æ–¥–µ
    document.getElementById('session-name').addEventListener('input', validateForm);
    document.getElementById('genre').addEventListener('change', validateForm);
    document.getElementById('story').addEventListener('input', validateForm);

    function validateForm() {
      const name = document.getElementById('session-name').value;
      const genre = document.getElementById('genre').value;
      const story = document.getElementById('story').value;
      document.getElementById('save-btn').disabled = !(name && genre && story);
    }
  </script>
</body>
</html>